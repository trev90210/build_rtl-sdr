name: libusb Windows build and Package

on: [workflow_dispatch, push, pull_request]

jobs:
  build:
    strategy:
      matrix:
        os:
        #  - 'windows-2022'
          - 'windows-2025'
        configuration:
          - 'Release'
        architecture:
          - 'Win32'
          - 'x64'
          - 'ARM64'

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: clone
        run: |
          git clone https://github.com/trev90210/libusb
          cd libusb
          cmd.exe /c "dir"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        

    
      - name: Configure Visual Studio and CMake
        working-directory: ${{runner.workspace}}
        run: |
            cd ${{ github.workspace }}
            # setup the compiler
            cmd.exe /c "call `"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat`" && set > %temp%\vcvars.txt"
            Get-Content "$env:temp\vcvars.txt" | Foreach-Object { if ($_ -match "^(.*?)=(.*)$") { Set-Content "env:\$($matches[1])" $matches[2] } }
            # run cmake, looks v141_xp Toolset requires VS 2019
            cmake -G "Visual Studio 17 2022" -A Win32 -S libusb -B build_ExtIO_RTL
            cmd.exe /c dir /s
